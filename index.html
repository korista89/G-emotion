<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IBRST í–‰ë™ë°ì´í„° ì‹œìŠ¤í…œ (ì—…ë°ì´íŠ¸)</title>
<style>
  body {font-family:'Malgun Gothic','ë§‘ì€ ê³ ë”•',Arial,sans-serif;margin:0;padding:20px;background:#f5f5f5}
  .container {max-width:1100px;margin:0 auto;background:white;border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,0.12);overflow:hidden}
  .header {background:#4a90e2;color:white;padding:20px;text-align:center}
  .tabs {display:flex;background:#e8e8e8;gap:2px}
  .tab-btn {flex:1;padding:14px 10px;background:#dcdcdc;border:none;cursor:pointer;font-size:16px;font-weight:700}
  .tab-btn.active {background:white;color:#4a90e2}
  .content {padding:26px}
  .tab-content {display:none}
  .tab-content.active {display:block}
  input,select,textarea {width:100%;padding:10px;margin:5px 0;border:1px solid #ddd;border-radius:8px;box-sizing:border-box}
  button {background:#4a90e2;color:white;padding:10px 16px;border:none;border-radius:8px;cursor:pointer;font-size:15px;margin:6px 5px}
  button:hover {background:#357abd}
  table {width:100%;border-collapse:collapse;margin-top:14px}
  th,td {border:1px solid #e6e6e6;padding:10px;text-align:center;font-size:14px}
  th {background:#fafafa}
  .form-group {margin:16px 0}
  .form-row {display:grid;grid-template-columns:160px 1fr;gap:12px;align-items:center}
  .msg {padding:10px;border-radius:8px;margin:10px 0}
  .success {background:#d4edda;color:#155724}
  .error {background:#f8d7da;color:#721c24}
  .hidden {display:none}
  #canvas {border:1px solid #ddd;margin-top:16px;border-radius:8px}
  .analysis-box {background:#f8f9fa;padding:16px;border-radius:8px;margin-top:16px}
  .analysis-box h4 {margin-top:14px;color:#333}
  .chk-row {display:flex;gap:10px;flex-wrap:wrap}
  .chk-row label {display:flex;align-items:center;gap:6px;background:#f7f7f7;border:1px solid #e8e8e8;padding:6px 10px;border-radius:20px}
  .danger {background:#e74c3c}
  .danger:hover {background:#c0392b}
  .muted {background:#9aa5b1}
  .muted:hover {background:#7b8794}
  .note {font-size:12px;color:#666}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>ğŸ“Š IBRST í–‰ë™ë°ì´í„° ì‹œìŠ¤í…œ</h1>
  </div>

  <!-- 8. íƒ­ ìœ„ì¹˜: ë°ì´í„°ì…ë ¥, ì°¨íŠ¸ë¶„ì„, í•™ìƒë“±ë¡ ìˆœì„œ -->
  <div class="tabs">
    <button class="tab-btn active" data-tab="input">ë°ì´í„° ì…ë ¥</button>
    <button class="tab-btn" data-tab="chart">ì°¨íŠ¸ ë¶„ì„</button>
    <button class="tab-btn" data-tab="register">í•™ìƒ ë“±ë¡</button>
  </div>

  <div class="content">
    <!-- ë°ì´í„° ì…ë ¥ -->
    <div id="input" class="tab-content active">
      <h2>ë°ì´í„° ì…ë ¥</h2>
      <div class="form-group form-row">
        <label>í•™ìƒ ì„ íƒ:</label>
        <select id="student-select">
          <option value="">-- í•™ìƒì„ ì„ íƒí•˜ì„¸ìš” --</option>
        </select>
      </div>

      <div id="input-form" class="hidden">
        <div class="form-group form-row">
          <label>ë‚ ì§œ:</label>
          <input type="date" id="input-date">
        </div>

        <!-- 2. ì ìˆ˜ ì…ë ¥(ìˆ«ì + ì²´í¬ë°•ìŠ¤ ê°€ë¡œ ë°°ì¹˜) -->
        <div class="form-group">
          <div class="form-row">
            <label>ì¦ê°€ ëª©í‘œí–‰ë™ ì ìˆ˜ (0â€“5):</label>
            <input type="number" id="inc-score" min="0" max="5" step="1" inputmode="numeric">
          </div>
          <div class="chk-row" id="inc-score-chks"></div>
          <div class="note">ìˆ«ì ì…ë ¥ ë˜ëŠ” ì²´í¬ë°•ìŠ¤ ì„ íƒ ì¤‘ í¸í•œ ë°©ì‹ì„ ì‚¬ìš©í•˜ì„¸ìš”.</div>
        </div>

        <div class="form-group">
          <div class="form-row">
            <label>ê°ì†Œ ëª©í‘œí–‰ë™ ì ìˆ˜ (0â€“5):</label>
            <input type="number" id="dec-score" min="0" max="5" step="1" inputmode="numeric">
          </div>
          <div class="chk-row" id="dec-score-chks"></div>
        </div>

        <div class="form-group form-row">
          <label>ë©”ëª¨:</label>
          <textarea id="input-memo" rows="2" placeholder="ì§§ì€ ë©”ëª¨ (ì„ íƒ)"></textarea>
        </div>

        <div>
          <button id="save-data-btn">ë°ì´í„° ì €ì¥</button>
          <button id="delete-student-btn" class="danger">í•™ìƒ ì‚­ì œ(ì „ì²´ ë°ì´í„°)</button>
          <span class="note">â€¢ ì €ì¥ í›„ ë‚ ì§œëŠ” ìë™ìœ¼ë¡œ ë‹¤ìŒ ë‚ ì§œë¡œ ì´ë™</span>
        </div>

        <div id="data-msg" class="msg hidden"></div>

        <h3 style="margin-top:16px;">ë°ì´í„° ê¸°ë¡</h3>
        <table id="data-table">
          <thead>
            <tr><th>íšŒê¸°</th><th>ë‚ ì§œ</th><th>ì¦ê°€</th><th>ê°ì†Œ</th><th>ë©”ëª¨</th><th>ì‚­ì œ</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- ì°¨íŠ¸ ë¶„ì„ -->
    <div id="chart" class="tab-content">
      <h2>ì°¨íŠ¸ ë¶„ì„</h2>
      <div class="form-group form-row">
        <label>í•™ìƒ ì„ íƒ:</label>
        <select id="chart-student">
          <option value="">-- í•™ìƒì„ ì„ íƒí•˜ì„¸ìš” --</option>
        </select>
      </div>
      <button id="draw-chart-btn">ì°¨íŠ¸ ê·¸ë¦¬ê¸°</button>
      <canvas id="canvas" width="900" height="520" class="hidden"></canvas>
      <div id="analysis" class="hidden"></div>
    </div>

    <!-- í•™ìƒ ë“±ë¡ -->
    <div id="register" class="tab-content">
      <h2>í•™ìƒ ë“±ë¡</h2>
      <div class="form-group form-row">
        <label>í•™ìƒ ì´ë¦„:</label>
        <input type="text" id="student-name" placeholder="ì˜ˆ: ê¹€ë¯¼ìˆ˜">
      </div>
      <div class="form-group form-row">
        <label>í•™ë…„:</label>
        <select id="student-grade">
          <option value="">-- ì„ íƒ --</option>
          <option>ìœ ì¹˜ì›</option>
          <option>ì´ˆ1</option><option>ì´ˆ2</option><option>ì´ˆ3</option>
          <option>ì´ˆ4</option><option>ì´ˆ5</option><option>ì´ˆ6</option>
          <option>ì¤‘1</option><option>ì¤‘2</option><option>ì¤‘3</option>
          <option>ê³ 1</option><option>ê³ 2</option><option>ê³ 3</option>
        </select>
      </div>
      <div class="form-group form-row">
        <label>ì¦ê°€ ëª©í‘œí–‰ë™:</label>
        <input type="text" id="inc-behavior" placeholder="ì˜ˆ: ê³¼ì œì°¸ì—¬">
      </div>
      <div class="form-group form-row">
        <label>ê°ì†Œ ëª©í‘œí–‰ë™:</label>
        <input type="text" id="dec-behavior" placeholder="ì˜ˆ: ìë¦¬ì´íƒˆ">
      </div>
      <div>
        <button id="register-btn">í•™ìƒ ë“±ë¡</button>
        <button id="reset-local-btn" class="muted">ë¡œì»¬ ë°ì´í„° ì´ˆê¸°í™”</button>
      </div>
      <div id="register-msg" class="msg hidden"></div>
    </div>
  </div>
</div>

<script>
// ===== ì „ì—­ =====
let students = [];
let dataRecords = {};
let currentStudent = null;

// â˜… ë°°í¬ëœ Apps Script WebApp URLì„ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyE9fJcOS-h5O9RhEk4Evh9yOim-FMiB6l5MySGXF3FS4INYZzcdFfjv5jJdcHcMxyc/exec";

// ===== ìœ í‹¸ =====
function showMessage(id, msg, type) {
  const el = document.getElementById(id);
  el.className = 'msg ' + type;
  el.textContent = msg;
  el.classList.remove('hidden');
  setTimeout(() => el.classList.add('hidden'), 2500);
}

function saveToStorage() {
  localStorage.setItem('ibrst_students', JSON.stringify(students));
  localStorage.setItem('ibrst_data', JSON.stringify(dataRecords));
}
function loadFromStorage() {
  try {
    const s = localStorage.getItem('ibrst_students');
    const d = localStorage.getItem('ibrst_data');
    if (s) students = JSON.parse(s);
    if (d) dataRecords = JSON.parse(d);
  } catch(e) { console.log('ë¡œë“œ ì˜¤ë¥˜:', e); }
}

function updateStudentLists() {
  ['student-select','chart-student'].forEach(id => {
    const sel = document.getElementById(id);
    sel.innerHTML = '<option value="">-- í•™ìƒì„ ì„ íƒí•˜ì„¸ìš” --</option>';
    students.forEach(s => sel.innerHTML += `<option value="${s.id}">${s.name} (${s.grade})</option>`);
  });
}

// ì²´í¬ë°•ìŠ¤ ë¹Œë”
function buildScoreChecks(containerId, inputId) {
  const cont = document.getElementById(containerId);
  cont.innerHTML = '';
  for (let i=0;i<=5;i++) {
    const lid = `${containerId}-v${i}`;
    const lab = document.createElement('label');
    lab.innerHTML = `<input type="radio" name="${containerId}" id="${lid}" value="${i}"> ${i}`;
    cont.appendChild(lab);
  }
  // ë™ê¸°í™”: ì²´í¬ â†’ ì…ë ¥
  cont.addEventListener('change', (e)=>{
    const v = parseInt(e.target.value);
    const inp = document.getElementById(inputId);
    inp.value = v;
  });
  // ì…ë ¥ â†’ ì²´í¬
  document.getElementById(inputId).addEventListener('input', (e)=>{
    let v = parseInt(e.target.value);
    if (isNaN(v)) return;
    if (v<0) v=0; if (v>5) v=5;
    e.target.value = v;
    const radios = cont.querySelectorAll('input[type=radio]');
    radios.forEach(r => r.checked = (parseInt(r.value)===v));
  });
}

// ===== ì´ˆê¸°í™” =====
document.addEventListener('DOMContentLoaded', async () => {
  loadFromStorage();

  // íƒ­ ì „í™˜
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      this.classList.add('active');
      document.getElementById(this.dataset.tab).classList.add('active');
    });
  });

  // ì´ë²¤íŠ¸
  document.getElementById('register-btn').addEventListener('click', registerStudent);
  document.getElementById('reset-local-btn').addEventListener('click', ()=>{localStorage.clear();location.reload();});
  document.getElementById('save-data-btn').addEventListener('click', saveData);
  document.getElementById('student-select').addEventListener('change', onSelectStudent);
  document.getElementById('draw-chart-btn').addEventListener('click', drawChart);
  document.getElementById('delete-student-btn').addEventListener('click', deleteStudentAll);

  // ë‚ ì§œ ì´ˆê¸°ê°’
  document.getElementById('input-date').value = new Date().toISOString().split('T')[0];

  // ì ìˆ˜ ì²´í¬ë°•ìŠ¤ ìƒì„±
  buildScoreChecks('inc-score-chks','inc-score');
  buildScoreChecks('dec-score-chks','dec-score');

  // ìµœì‹  ì„œë²„ ë°ì´í„° ë™ê¸°í™”(11,12)
  await syncFromServer();

  updateStudentLists();
});

// ===== í•™ìƒ ë“±ë¡ =====
async function registerStudent() {
  const name = document.getElementById('student-name').value.trim();
  const grade = document.getElementById('student-grade').value;
  const incBehavior = document.getElementById('inc-behavior').value.trim();
  const decBehavior = document.getElementById('dec-behavior').value.trim();

  if (!name || !grade || !incBehavior || !decBehavior) {
    showMessage('register-msg','ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.','error'); return;
  }

  const student = { id: Date.now().toString(), name, grade, incBehavior, decBehavior };
  students.push(student);
  dataRecords[student.id] = [];
  saveToStorage();
  updateStudentLists();

  // ì„œë²„ ë™ê¸°í™”
  try {
    await fetch(WEBAPP_URL, { method:'POST', body: JSON.stringify({action:'registerStudent', student}) });
  } catch(e) { console.log(e); }

  document.getElementById('student-name').value='';
  document.getElementById('student-grade').value='';
  document.getElementById('inc-behavior').value='';
  document.getElementById('dec-behavior').value='';
  showMessage('register-msg','í•™ìƒì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.','success');
}

// ===== í•™ìƒ ì„ íƒ =====
async function onSelectStudent() {
  const studentId = document.getElementById('student-select').value;
  if (!studentId) { document.getElementById('input-form').classList.add('hidden'); return; }
  currentStudent = students.find(s => s.id === studentId);
  document.getElementById('input-form').classList.remove('hidden');

  // ì„œë²„ì—ì„œ ìµœì‹  ì„¸ì…˜ ë¶ˆëŸ¬ì˜¤ê¸°
  try {
    const res = await fetch(`${WEBAPP_URL}?action=getStudentData&studentId=${encodeURIComponent(studentId)}`);
    const payload = await res.json();
    if (payload && Array.isArray(payload.records)) {
      dataRecords[studentId] = payload.records;
      saveToStorage();
    }
  } catch(e){ console.log(e); }
  updateDataTable();
}

// ===== ë°ì´í„° ì €ì¥ =====
async function saveData() {
  if (!currentStudent) return;
  const date = document.getElementById('input-date').value;
  const incScore = parseInt(document.getElementById('inc-score').value);
  const decScore = parseInt(document.getElementById('dec-score').value);
  const memo = document.getElementById('input-memo').value;

  if (!date || isNaN(incScore) || isNaN(decScore)) {
    showMessage('data-msg','ë‚ ì§œì™€ ì ìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.','error'); return;
  }
  if (incScore<0 || incScore>5 || decScore<0 || decScore>5) {
    showMessage('data-msg','ì ìˆ˜ëŠ” 0â€“5 ì‚¬ì´ì—¬ì•¼ í•©ë‹ˆë‹¤.','error'); return;
  }

  const studentData = dataRecords[currentStudent.id] || [];
  // íšŒê¸° ê²°ì •: ê°™ì€ ë‚ ì§œê°€ ìˆìœ¼ë©´ ê·¸ íšŒê¸°ë¥¼ ëŒ€ì²´, ì—†ìœ¼ë©´ +1
  let session = 1;
  const sameDate = studentData.filter(d => d.date === date);
  if (sameDate.length>0) {
    session = sameDate[0].session;
    studentData.forEach(d => { if (d.session===session) d.valid = false; });
  } else {
    const sessions = studentData.map(d => d.session);
    session = sessions.length>0 ? Math.max(...sessions)+1 : 1;
  }

  const newData = { session, date, incScore, decScore, memo, timestamp: Date.now(), valid:true };
  studentData.push(newData);
  dataRecords[currentStudent.id] = studentData;
  saveToStorage();

  // ì„œë²„ ë°˜ì˜
  try {
    await fetch(WEBAPP_URL, { method:'POST', body: JSON.stringify({action:'upsertRecord', studentId: currentStudent.id, record: newData}) });
  } catch(e){ console.log(e); }

  // 1. ë‚ ì§œ ì €ì¥ í›„ ë‹¤ìŒ ë‚ ì§œë¡œ ì´ë™
  const nextDate = new Date(date); nextDate.setDate(nextDate.getDate()+1);
  document.getElementById('input-date').value = nextDate.toISOString().split('T')[0];

  // ì…ë ¥ ì´ˆê¸°í™” & í…Œì´ë¸” ê°±ì‹ 
  document.getElementById('inc-score').value='';
  document.getElementById('dec-score').value='';
  document.getElementById('input-memo').value='';
  document.querySelectorAll('#inc-score-chks input, #dec-score-chks input').forEach(r=>r.checked=false);

  updateDataTable();
  showMessage('data-msg','ë°ì´í„°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.','success');
}

// ===== ë ˆì½”ë“œ ì‚­ì œ(íšŒê¸°ë³„) =====
async function deleteRecord(session) {
  if (!currentStudent) return;
  // ë¡œì»¬: í•´ë‹¹ íšŒê¸°ì˜ valid=false ì²˜ë¦¬ + ì¦‰ì‹œ í…Œì´ë¸” ê°±ì‹ 
  const arr = dataRecords[currentStudent.id] || [];
  arr.forEach(d => { if (d.session===session) d.valid=false; });
  saveToStorage();
  updateDataTable();

  // ì„œë²„ ì‚­ì œ
  try {
    await fetch(WEBAPP_URL, { method:'POST', body: JSON.stringify({action:'deleteRecord', studentId: currentStudent.id, session}) });
  } catch(e){ console.log(e); }
}

// ===== í•™ìƒ ì „ì²´ ì‚­ì œ =====
async function deleteStudentAll() {
  if (!currentStudent) return;
  if (!confirm('í•™ìƒ ì „ì²´ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) return;

  // ë¡œì»¬ ì œê±°
  const id = currentStudent.id;
  students = students.filter(s => s.id !== id);
  delete dataRecords[id];
  currentStudent = null;
  saveToStorage();
  updateStudentLists();
  document.getElementById('input-form').classList.add('hidden');

  // ì„œë²„ ì œê±°
  try {
    await fetch(WEBAPP_URL, { method:'POST', body: JSON.stringify({action:'deleteStudent', studentId: id}) });
  } catch(e){ console.log(e); }

  showMessage('data-msg','í•™ìƒ ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.','success');
}

// ===== ì„œë²„ â†’ ë¡œì»¬ ë™ê¸°í™” =====
async function syncFromServer() {
  if (!WEBAPP_URL || WEBAPP_URL.startsWith('YOUR_')) return; // URL ë¯¸ì„¤ì • ì‹œ ìŠ¤í‚µ
  try {
    const res = await fetch(`${WEBAPP_URL}?action=getAll`);
    const payload = await res.json();
    if (payload && Array.isArray(payload.students)) {
      students = payload.students;
      dataRecords = payload.dataRecords || {};
      saveToStorage();
    }
  } catch(e){ console.log(e); }
}

// ===== í…Œì´ë¸” =====
function updateDataTable() {
  if (!currentStudent) return;
  const tbody = document.querySelector('#data-table tbody');
  const data = dataRecords[currentStudent.id] || [];
  const validBySession = {};
  data.forEach(d => { if (d.valid) validBySession[d.session] = d; });
  const rows = Object.values(validBySession).sort((a,b)=>a.session-b.session);
  if (rows.length===0) {
    tbody.innerHTML = '<tr><td colspan="6">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>'; return;
  }
  let html = '';
  rows.forEach(d => {
    html += `<tr>
      <td>${d.session}</td>
      <td>${d.date}</td>
      <td>${d.incScore}</td>
      <td>${d.decScore}</td>
      <td>${d.memo || '-'}</td>
      <td><button class="danger" onclick="deleteRecord(${d.session})">ì‚­ì œ</button></td>
    </tr>`;
  });
  tbody.innerHTML = html;
}

// ===== ì°¨íŠ¸ =====
function drawChart() {
  const studentId = document.getElementById('chart-student').value;
  if (!studentId) { alert('í•™ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
  const student = students.find(s => s.id === studentId);
  const data = (dataRecords[studentId] || []).filter(d=>d.valid).sort((a,b)=>a.session-b.session);
  if (data.length < 3) { alert('ìµœì†Œ 3íšŒê¸° ì´ìƒì˜ ë°ì´í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤.'); return; }

  const canvas = document.getElementById('canvas');
  canvas.classList.remove('hidden');
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;

  ctx.clearRect(0,0,W,H);
  ctx.fillStyle='#fff'; ctx.fillRect(0,0,W,H);

  // ì œëª©
  ctx.fillStyle='#333'; ctx.font='bold 18px Arial'; ctx.textAlign='center';
  ctx.fillText(`${student.name} í•™ìƒ í–‰ë™ ë°ì´í„° ì°¨íŠ¸`, W/2, 28);

  const padLeft=70, padTop=60, padRight=60, padBottom=90;
  const cw = W - padLeft - padRight, ch = H - padTop - padBottom;

  // ì¶•/ê²©ì
  ctx.strokeStyle='#e0e0e0'; ctx.lineWidth=0.7;
  for (let i=0;i<=5;i++){
    const y = padTop + (ch/5)*i;
    ctx.beginPath(); ctx.moveTo(padLeft, y); ctx.lineTo(padLeft+cw, y); ctx.stroke();
  }

  const xStep = cw / (data.length - 1);
  for (let i=0;i<data.length;i++){
    const x = padLeft + i*xStep;
    ctx.beginPath(); ctx.moveTo(x, padTop); ctx.lineTo(x, padTop+ch); ctx.stroke();
  }

  // ì¶•
  ctx.strokeStyle='#000'; ctx.lineWidth=2;
  ctx.beginPath();
  ctx.moveTo(padLeft, padTop);
  ctx.lineTo(padLeft, padTop+ch);
  ctx.lineTo(padLeft+cw, padTop+ch);
  ctx.stroke();

  // yì¶• ëˆˆê¸ˆ
  ctx.lineWidth=1; ctx.fillStyle='#333'; ctx.textAlign='right'; ctx.font='12px Arial';
  for (let i=0;i<=5;i++){
    const y = padTop + ch - (ch/5)*i;
    ctx.beginPath(); ctx.moveTo(padLeft-5, y); ctx.lineTo(padLeft, y); ctx.stroke();
    ctx.fillText(i, padLeft-10, y+4);
  }

  // xì¶• ë‚ ì§œ
  ctx.textAlign='center'; ctx.font='11px Arial';
  data.forEach((d,i)=>{
    const x = padLeft + i*xStep;
    ctx.beginPath(); ctx.moveTo(x, padTop+ch); ctx.lineTo(x, padTop+ch-5); ctx.stroke();
    const dt = new Date(d.date); const ds = `${dt.getMonth()+1}/${dt.getDate()}`;
    ctx.fillText(ds, x, padTop+ch+18);
    ctx.fillText(`${d.session}íšŒê¸°`, x, padTop+ch+34);
  });

  // 3. ê¸°ì´ˆì„  ê¸¸ì´(ê¸°ë³¸ 3íšŒë¡œ ë³€ê²½)
  const BASE_N = 3;
  const baseline = data.slice(0, Math.min(BASE_N, data.length));
  const intervention = data.slice(baseline.length);

  // 5. ì¤‘ì¬ êµ¬ë¶„ì„ (3íšŒê¸°ì™€ 4íšŒê¸° ì‚¬ì´ ì¤‘ì•™)
  if (intervention.length>0){
    const x3 = padLeft + (baseline.length-1)*xStep; // 3íšŒê¸° x
    const x4 = padLeft + (baseline.length)*xStep;   // 4íšŒê¸° x
    const xc = (x3 + x4) / 2;
    ctx.strokeStyle='#000'; ctx.lineWidth=2;
    ctx.beginPath(); ctx.moveTo(xc, padTop); ctx.lineTo(xc, padTop+ch); ctx.stroke();
  }

  // 6. 3â†’4 ì—°ê²° ëŠê¸°: ì„ ì„ ë‘ êµ¬ê°„ìœ¼ë¡œ ë‚˜ëˆ  ê·¸ë¦¼
  function yFrom(score){ return padTop + ch - (score/5)*ch; }

  // ì¦ê°€(íŒŒë€)
  ctx.strokeStyle='#4a90e2'; ctx.lineWidth=2;
  ctx.beginPath();
  baseline.forEach((d,i)=>{ const x=padLeft+i*xStep, y=yFrom(d.incScore); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); });
  ctx.stroke();
  if (intervention.length>0){
    ctx.beginPath();
    intervention.forEach((d,i)=>{ const x=padLeft+(baseline.length+i)*xStep, y=yFrom(d.incScore); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); });
    ctx.stroke();
  }

  // ê°ì†Œ(ë¹¨ê°•)
  ctx.strokeStyle='#e74c3c'; ctx.lineWidth=2;
  ctx.beginPath();
  baseline.forEach((d,i)=>{ const x=padLeft+i*xStep, y=yFrom(d.decScore); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); });
  ctx.stroke();
  if (intervention.length>0){
    ctx.beginPath();
    intervention.forEach((d,i)=>{ const x=padLeft+(baseline.length+i)*xStep, y=yFrom(d.decScore); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); });
    ctx.stroke();
  }

  // ë°ì´í„° í¬ì¸íŠ¸
  data.forEach((d,i)=>{
    const x = padLeft + i*xStep;
    // ì¦ê°€: ì›
    let y = yFrom(d.incScore);
    ctx.fillStyle='#fff'; ctx.strokeStyle='#4a90e2'; ctx.lineWidth=2;
    ctx.beginPath(); ctx.arc(x,y,5,0,Math.PI*2); ctx.fill(); ctx.stroke();
    ctx.fillStyle='#4a90e2'; ctx.font='bold 11px Arial'; ctx.fillText(d.incScore, x, y-10);

    // ê°ì†Œ: ì‚¼ê°í˜•
    y = yFrom(d.decScore);
    ctx.fillStyle='#fff'; ctx.strokeStyle='#e74c3c';
    ctx.beginPath(); ctx.moveTo(x,y-6); ctx.lineTo(x-5,y+4); ctx.lineTo(x+5,y+4); ctx.closePath(); ctx.fill(); ctx.stroke();
    ctx.fillStyle='#e74c3c'; ctx.fillText(d.decScore, x, y+20);
  });

  // 7. 'ê¸°ì´ˆì„ ' / 'ì¤‘ì¬' í‘œì‹œ
  ctx.fillStyle='#000'; ctx.font='bold 14px Arial'; ctx.textAlign='center';
  if (baseline.length>0){
    const bx0 = padLeft, bx1 = padLeft + (baseline.length-1)*xStep;
    ctx.fillText('ê¸°ì´ˆì„ ', (bx0+bx1)/2, padTop-12);
  }
  if (intervention.length>0){
    const ix0 = padLeft + baseline.length*xStep, ix1 = padLeft + (data.length-1)*xStep;
    ctx.fillText('ì¤‘ì¬', (ix0+ix1)/2, padTop-12);
  }

  // ë²”ë¡€
  ctx.fillStyle='#4a90e2'; ctx.fillRect(padLeft+cw-170, padTop+10, 14, 14);
  ctx.fillStyle='#333'; ctx.font='12px Arial'; ctx.textAlign='left';
  ctx.fillText('ì¦ê°€ ëª©í‘œí–‰ë™', padLeft+cw-150, padTop+21);

  ctx.fillStyle='#e74c3c'; ctx.fillRect(padLeft+cw-170, padTop+34, 14, 14);
  ctx.fillStyle='#333'; ctx.fillText('ê°ì†Œ ëª©í‘œí–‰ë™', padLeft+cw-150, padTop+45);

  // ë¶„ì„
  performABAAnalysis(student, data, BASE_N);
}

// ===== ë¶„ì„(4. ë¬¸êµ¬ ìˆ˜ì • í¬í•¨ / 3. ê¸°ë³¸ ê¸°ì´ˆì„ =3íšŒ) =====
function performABAAnalysis(student, data, BASE_N) {
  const analysis = document.getElementById('analysis');
  analysis.classList.remove('hidden');

  const baselineData = data.slice(0, Math.min(BASE_N, data.length));
  const interventionData = data.slice(Math.min(BASE_N, data.length));

  const mean = arr => arr.reduce((a,b)=>a+b,0)/arr.length;
  const trend = arr => {
    const n=arr.length, xs=[...Array(n).keys()];
    const sumX=xs.reduce((a,b)=>a+b,0);
    const sumY=arr.reduce((a,b)=>a+b,0);
    const sumXY=arr.reduce((s,y,i)=>s+i*y,0);
    const sumX2=xs.reduce((s,i)=>s+i*i,0);
    const slope=(n*sumXY - sumX*sumY) / (n*sumX2 - sumX*sumX || 1);
    return slope>0.05?'ìƒìŠ¹':(slope<-0.05?'í•˜ë½':'ì•ˆì •');
  };

  const incScores = data.map(d=>d.incScore);
  const decScores = data.map(d=>d.decScore);
  const baseInc = baselineData.map(d=>d.incScore);
  const baseDec = baselineData.map(d=>d.decScore);
  const intInc = interventionData.map(d=>d.incScore);
  const intDec = interventionData.map(d=>d.decScore);

  let html = '<div class="analysis-box">';
  html += `<h3>${student.name} (${student.grade}) í–‰ë™ ë¶„ì„ ê²°ê³¼</h3>`;

  html += '<h4>1. ê¸°ìˆ í†µê³„</h4>';
  html += `<p>â€¢ ì¦ê°€ ëª©í‘œí–‰ë™(${student.incBehavior}): ì „ì²´ í‰ê·  ${mean(incScores).toFixed(2)}ì </p>`;
  html += `<p>â€¢ ê°ì†Œ ëª©í‘œí–‰ë™(${student.decBehavior}): ì „ì²´ í‰ê·  ${mean(decScores).toFixed(2)}ì </p>`;

  if (interventionData.length>0) {
    html += '<h4>2. ë‹¨ê³„ë³„ ë¶„ì„</h4>';
    const baseIncM = mean(baseInc).toFixed(2);
    const intIncM = mean(intInc).toFixed(2);
    const baseDecM = mean(baseDec).toFixed(2);
    const intDecM = mean(intDec).toFixed(2);
    const incPct = ((intInc - baseInc.reduce((a,b)=>a+b,0)/baseInc.length) / (baseInc.reduce((a,b)=>a+b,0)/baseInc.length) * 100).toFixed(1);
    const decPct = ((baseDec.reduce((a,b)=>a+b,0)/baseDec.length - intDec) / (baseDec.reduce((a,b)=>a+b,0)/baseDec.length) * 100).toFixed(1);

    // 4. ë¬¸êµ¬ ë³€ê²½
    html += `<p>â€¢ ê¸°ì´ˆì„  ì¦ê°€ëª©í‘œí–‰ë™: ${baseIncM}ì  â†’ ì¤‘ì¬êµ¬ê°„ ì¦ê°€ëª©í‘œí–‰ë™ ${intIncM}ì  (${(( (mean(intInc)-mean(baseInc))/mean(baseInc))*100).toFixed(1)}% ë³€í™”)</p>`;
    html += `<p>â€¢ ê¸°ì´ˆì„  ê°ì†Œëª©í‘œí–‰ë™: ${baseDecM}ì  â†’ ì¤‘ì¬êµ¬ê°„ ê°ì†Œëª©í‘œí–‰ë™ ${intDecM}ì  (${(( (mean(baseDec)-mean(intDec))/mean(baseDec))*100).toFixed(1)}% ê°ì†Œ)</p>`;

    html += '<h4>3. ê²½í–¥ì„± ë¶„ì„</h4>';
    html += `<p>â€¢ ì¦ê°€ ëª©í‘œí–‰ë™: ${trend(intInc)} ê²½í–¥</p>`;
    html += `<p>â€¢ ê°ì†Œ ëª©í‘œí–‰ë™: ${trend(intDec)} ê²½í–¥</p>`;

    // PND
    const pndInc = intInc.filter(v => v > Math.max(...baseInc)).length / intInc.length * 100;
    const pndDec = intDec.filter(v => v < Math.min(...baseDec)).length / intDec.length * 100;
    html += '<h4>4. íš¨ê³¼í¬ê¸° (PND)</h4>';
    html += `<p>â€¢ ì¦ê°€ ëª©í‘œí–‰ë™ PND: ${pndInc.toFixed(1)}%</p>`;
    html += `<p>â€¢ ê°ì†Œ ëª©í‘œí–‰ë™ PND: ${pndDec.toFixed(1)}%</p>`;
  }

  html += '<h4>5. ì¤‘ì¬ ê¶Œê³ </h4>';
  const incMean = mean(incScores), decMean = mean(decScores);
  if (incMean < 2.5) html += '<p>â€¢ ê°•í™”(ê°•í™”ë¬¼ ì¬í‰ê°€, ê°•í™”ê³„íš ì¡°ì •) í•„ìš”</p>';
  if (decMean > 2.5) html += '<p>â€¢ ì„ í–‰ì‚¬ê±´ ìˆ˜ì •(Antecedent) ë° ëŒ€ì²´í–‰ë™ ì§€ë„ ê°•í™”</p>';
  if (incMean >= 4 && decMean <= 1) html += '<p>â€¢ ìœ ì§€Â·ì¼ë°˜í™” ë‹¨ê³„ ì „í™˜ ê²€í† </p>';
  html += '<p>â€¢ ì£¼ê°„ íŒ€ ë¯¸íŒ…ì—ì„œ ë°ì´í„° ê²€í†  ê¶Œì¥</p>';

  html += '</div>';
  analysis.innerHTML = html;
}
</script>
</body>
</html>